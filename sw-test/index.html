<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="manifest" href="/test/sw-test/manifest.json">
  <meta name="theme-color" content="#0070b3">

  <!-- iOS 用。iOS は manifest だけでは不足 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/test/sw-test/img/ico/icon-192.png">

  <title>Document</title>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/test/sw-test/sw.js').then(function() { console.log('Service Worker Registered'); });
    }
  </script>
</head>
<body>
  <h1>SE-TEST</h1>
  <hr>
  <br>

  <div id="a2hs-banner" style="display:none; position:fixed; inset:auto 0 0 0; padding:12px; background:#fff; box-shadow:0 -4px 12px rgba(0,0,0,.15); z-index:2147483647;">
    <!-- iOS向けメッセージ -->
    <div id="ios-a2hs-hint" style="display:none;">
      iPhoneでは、Safariでこのページを開き<br>
      共有（⬆️）→「ホーム画面に追加」を選んでください。
    </div>

    <!-- Android向けボタン -->
    <button id="a2hs-btn" style="display:none;">ホーム画面に追加</button>

    <!-- 以後表示しない（どの環境でも有効） -->
    <button id="js-closeA2hs" style="margin-left:8px;">二度と表示しない</button>
  </div>

</body>

<script>
  (function () {
    // ===== Cookie helpers =====
    const ONE_YEAR = 60 * 60 * 24 * 365; // 1年（秒）
    const setCookie = (name, value, maxAgeSec = ONE_YEAR) => {
      document.cookie =
        encodeURIComponent(name) + '=' + encodeURIComponent(value) +
        '; max-age=' + maxAgeSec +
        '; path=/' +
        '; SameSite=Lax' +
        (location.protocol === 'https:' ? '; Secure' : '');
    };
    const getCookie = (name) => {
      const n = encodeURIComponent(name) + '=';
      return document.cookie.split('; ').reduce((acc, c) => {
        if (c.indexOf(n) === 0) return decodeURIComponent(c.substring(n.length));
        return acc;
      }, null);
    };
    const delCookie = (name) => setCookie(name, '', 0); // 即時削除

    // ===== Keys =====
    const KEY_DISMISSED = 'a2hs-dismissed'; // バナーを今後出さない
    const KEY_INSTALLED = 'pwa-installed';  // インストール済み

    // ===== Env =====
    const isIOS = () => /iPhone|iPad|iPod/.test(navigator.userAgent);
    const isStandalone = () =>
      window.matchMedia('(display-mode: standalone)').matches ||
      window.navigator.standalone === true; // iOS Safari

    // スタンドアロン（ホームアイコン or インストールアプリ）で開いたら「今日から1年」に更新
    if (isStandalone()) {
      setCookie(KEY_INSTALLED, 'yes', ONE_YEAR);
    }

    // 任意：前面復帰時にも延長（スタンドアロンのみ）
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && isStandalone()) {
        setCookie(KEY_INSTALLED, 'yes', ONE_YEAR);
      }
    });

    // UI参照
    const banner   = document.getElementById('a2hs-banner');
    const iosHint  = document.getElementById('ios-a2hs-hint');
    const a2hsBtn  = document.getElementById('a2hs-btn');
    const closeBtn = document.getElementById('js-closeA2hs');

    let deferredPrompt = null; // Android/Chrome 用

    // 表示制御
    const isDismissed = () => getCookie(KEY_DISMISSED) === 'yes';
    const isInstalled = () => getCookie(KEY_INSTALLED) === 'yes';
    const hideAll  = () => { if (banner) banner.style.display = 'none'; };
    const showBanner = () => { if (banner) banner.style.display = 'block'; };

    // ×ボタン：今後非表示（Cookie保存・最長1年）
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        setCookie(KEY_DISMISSED, 'yes', ONE_YEAR);
        hideAll();
      });
    }

    // 既にインストール済みなら非表示
    if (isInstalled()) {
      hideAll();
      return;
    }

    // iOS：Safari は手動ガイドのみ（beforeinstallprompt なし）
    if (isIOS() && !isStandalone() && !isDismissed()) {
      if (iosHint) iosHint.style.display = 'block';
      if (a2hsBtn) a2hsBtn.style.display = 'none';
      showBanner();
    }

    // Android/Chrome：インストール可能になったらイベントを捕捉
    window.addEventListener('beforeinstallprompt', (e) => {
      if (isDismissed()) return;
      e.preventDefault();               // 自動UIを抑止
      deferredPrompt = e;               // 後で使う
      if (a2hsBtn) a2hsBtn.style.display = 'inline-block';
      if (iosHint) iosHint.style.display = 'none';
      showBanner();
    });

    // Android/Chrome：自前ボタンでインストールUI表示
    if (a2hsBtn) {
      a2hsBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice; // 'accepted' or 'dismissed'
        deferredPrompt = null;
        hideAll();
      });
    }

    // Android/デスクトップChrome：インストール完了時に Cookie 記録＆以後非表示
    window.addEventListener('appinstalled', () => {
      setCookie(KEY_INSTALLED, 'yes', ONE_YEAR);
      hideAll();
    });
  })();
</script>

</html>
